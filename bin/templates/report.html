{% extends "base.html" %}

{% block content %}
  <body>
  <div align="center">
    <h1 align="center">WebLogPaser</h1>
    <table class="bordered">
      <caption align="left">Overall Analyzed Requests</caption>
      <tr>
        <th><strong>日志文件</strong></th>
        <td colspan="3"><strong>{{ data['source_file'] }}</strong></td>
        <td>
          <a href="{{ data['goaccess_file'] }}" target="_goaccess">{{ data['goaccess_title'] }}</a>
        </td>
      </tr>
      <tr>
        <th><strong>总PV</strong></th>
        <th><strong>总IP</strong></th>
        <th><strong>每秒最大处理消息数量</strong></th>
        <th><strong>最大处理消息时间</strong></th>
        <th><strong>每秒平均处理消息</strong></th>
      </tr>
      <tr>
        <td><strong>{{ data['pv'] }}</strong></td>
        <td><strong>{{ data['uv'] }}</strong></td>
        <td><strong>{{ data['response_peak'] }}</strong></td>
        <td><strong>{{ data['response_peak_time'] }}</strong></td>
        <td><strong>{{ data['response_avg'] }}</strong></td>
      </tr>
    </table>

    <br>

    <table class="bordered">
      <tr>
        <td>
          <div id="methodChart" style="height:200px"></div>
        </td>
      </tr>
    </table>

    <br>

    <table class="bordered">
      <tr>
        <td>
          <div id="hoursChart" style="height:400px; width: 670px;"></div>
        </td>
        <td>
          <div id="minutesChart" style="height:400px; width: 670px;"></div>
        </td>
      </tr>
      {% if second_line_flag %}
        <tr>
          <td>
            <div id="secondChart" style="height:400px"></div>
          </td>
        </tr>
      {% endif %}
    </table>

    <br>

    <table class="bordered">
      <tr>
        <td>
          <div id="costPChart" style="height:400px; width: 670px;"></div>
        </td>
        <td>
          <div id="costChart" style="height:400px; width: 670px;"></div>
        </td>
      </tr>
    </table>


    <br>

    <table class="bordered">
      <caption>
        Top requests<a href="../urls/{{ web_log_urls_file }}" target="_urls">（查看所有URL）</a>
      </caption>
      {% if data['url_data_list'][0].cost %}
        <tr>
          <th colspan="6" rowspan="2"><strong>Requests</strong></th>
          <th rowspan="2"><strong>访问量</strong></th>
          <th rowspan="2"><strong>比例</strong></th>
          <th rowspan="2"><strong>每秒最大处<br/>理消息数量</strong></th>
          <th rowspan="2"><strong>Method</strong></th>
          <th rowspan="2"><strong>Protocol</strong></th>
          <th colspan="4"><strong>耗时</strong></th>
        </tr>
        <tr>
          <th><strong>均值</strong></th>
          <th><strong>90%</strong></th>
          <th><strong>中值</strong></th>
          <th><strong>方差</strong></th>
        </tr>
      {% else %}
        <tr>
          <th colspan="6"><strong>Requests</strong></th>
          <th><strong>访问量</strong></th>
          <th><strong>比例</strong></th>
          <th><strong>每秒最大处<br/>理消息数量</strong></th>
          <th><strong>Method</strong></th>
          <th><strong>Protocol</strong></th>
        </tr>
      {% endif %}

      {% for url_data in data['url_data_list'] %}
        <tr>
          <td colspan="6">
            <strong>{{ url_data.url.split()[1]|replace("&amp;", "&")|wordwrap(width=70, break_long_words=True, wrapstring="<br/>")|safe }}</strong>
          </td>
          <td><strong>{{ url_data.pv }}</strong></td>
          <td><strong>{{ url_data.ratio }}%</strong></td>
          <td><strong>{{ url_data.peak }}</strong></td>
          <td><strong>{{ url_data.url.split()[0].replace('"', '') }}</strong></td>
          <td><strong>{{ url_data.url.split()[2].replace('"', '') }}</strong></td>
          {% if url_data.cost %}
            <td><strong>{{ url_data.cost_time['avg'] }}</strong></td>
            <td><strong>{{ url_data.cost_time['p9'] }}</strong></td>
            <td><strong>{{ url_data.cost_time['p5'] }}</strong></td>
            <td><strong>{{ url_data.cost_time['variance'] }}</strong></td>
          {% endif %}
        </tr>
      {% endfor %}

    </table>
  </div>

  <script src="http://echarts.baidu.com/build/dist/echarts.js"></script>

  <script type="text/javascript">
    require.config({
      paths: {
        echarts: 'http://echarts.baidu.com/build/dist'
      }
    });

    require(
        [
          'echarts',
          'echarts/theme/macarons',
          'echarts/chart/bar',
          'echarts/chart/line'
        ],
        function (ec, theme) {
          var hoursChart = ec.init(document.getElementById('hoursChart'), theme);

          var hoursOption = {
            title: {
              text: '每小时PV变化曲线图',
              subtext: ''
            },
            tooltip: {
              trigger: 'axis'
            },
            legend: {
              data: ['每小时PV']
            },
            toolbox: {
              show: true,
              feature: {
                mark: {show: false},
                dataView: {show: false, readOnly: false},
                magicType: {show: true, type: ['line', 'bar']},
                restore: {show: false},
                saveAsImage: {show: true}
              }
            },
            calculable: true,
            xAxis: [
              {
                type: 'category',
                boundaryGap: false,
                data: [{% for hour in hours_pv %}'{{ hour }}:00',{% endfor %}]
              }
            ],
            yAxis: [
              {
                type: 'value',
                axisLabel: {
                  formatter: '{value}'
                }
              }
            ],
            series: [
              {
                name: 'PV',
                type: 'line',
                data: [{% for hour in hours_pv %}{{ data['hours_hits'][hour] }}, {% endfor %}],
                markPoint: {
                  data: [
                    {type: 'max', name: '最大值'},
                    {type: 'min', name: '最小值'}
                  ]
                },
                markLine: {
                  data: [
                    {type: 'average', name: '平均值'}
                  ]
                }
              }
            ]
          };

          var minuteChart = ec.init(document.getElementById('minutesChart'), theme);

          var minuteOption = {
            title: {
              text: '每分钟PV变化曲线图',
              subtext: ''
            },
            tooltip: {
              trigger: 'axis'
            },
            legend: {
              data: ['每分钟PV']
            },
            toolbox: {
              show: true,
              feature: {
                mark: {show: false},
                dataView: {show: false, readOnly: false},
                magicType: {show: true, type: ['line', 'bar']},
                restore: {show: false},
                saveAsImage: {show: true}
              }
            },
            calculable: true,
            xAxis: [
              {
                type: 'category',
                boundaryGap: false,
                data: [{% for minute in minutes_pv %}'{{ minute }}',{% endfor %}]
              }
            ],
            yAxis: [
              {
                type: 'value',
                axisLabel: {
                  formatter: '{value}'
                }
              }
            ],
            series: [
              {
                name: 'PV',
                type: 'line',
                data: [{% for minute in minutes_pv %}{{ data['minutes_hits'][minute] }}, {% endfor %}],
                markPoint: {
                  data: [
                    {type: 'max', name: '最大值'},
                    {type: 'min', name: '最小值'}
                  ]
                },
                markLine: {
                  data: [
                    {type: 'average', name: '平均值'}
                  ]
                }
              }
            ]
          };

          {% if second_line_flag %}
            var secondChart = echarts.init(document.getElementById('secondChart'));

            var secondOption = {
              title: {
                text: '每秒PV变化曲线图',
                subtext: ''
              },
              tooltip: {
                trigger: 'axis'
              },
              legend: {
                data: ['每秒PV']
              },
              toolbox: {
                show: true,
                feature: {
                  mark: {show: false},
                  dataView: {show: false, readOnly: false},
                  magicType: {show: true, type: ['line', 'bar']},
                  restore: {show: false},
                  saveAsImage: {show: true}
                }
              },
              calculable: true,
              xAxis: [
                {
                  type: 'category',
                  boundaryGap: false,
                  data: [{% for second in seconds_pv %}'{{ second }}',{% endfor %}]
                }
              ],
              yAxis: [
                {
                  type: 'value',
                  axisLabel: {
                    formatter: '{value}'
                  }
                }
              ],
              series: [
                {
                  name: 'PV',
                  type: 'line',
                  data: [{% for second in seconds_pv %}{{ data['second_hits'][second] }}, {% endfor %}],
                  markPoint: {
                    data: [
                      {type: 'max', name: '最大值'},
                      {type: 'min', name: '最小值'}
                    ]
                  },
                  markLine: {
                    data: [
                      {type: 'average', name: '平均值'}
                    ]
                  }
                }
              ]
            };
            minuteChart.setOption(minuteOption);
          {% endif %}

          var methodChart = ec.init(document.getElementById('methodChart'), theme);

          var methodOption = {
            title: {
              text: 'GET和POST请求比例',
              subtext: ''
            },
            tooltip: {
              trigger: 'axis'
            },
            legend: {
              data: ['数量', '占比%']
            },
            toolbox: {
              show: true,
              feature: {
                mark: {show: false},
                dataView: {show: false, readOnly: false},
                magicType: {show: true, type: ['line', 'bar']},
                restore: {show: false},
                saveAsImage: {show: true}
              }
            },
            calculable: true,
            xAxis: [
              {
                type: 'value',
                boundaryGap: [0, 0.01]
              }
            ],
            yAxis: [
              {
                type: 'category',
                data: ['GET', 'POST']
              }
            ],
            series: [
              {
                name: '数量',
                type: 'bar',
                data: [{{ method_counts['get'] }}, {{ method_counts['post'] }}]
              },
              {
                name: '占比%',
                type: 'bar',
                data: ['{{ method_counts['get_percentile'] }}', '{{ method_counts['post_percentile'] }}' ]
              }
            ]
          };

          hoursChart.setOption(hoursOption);
          minuteChart.setOption(minuteOption);
          methodChart.setOption(methodOption);
        }
    );
  </script>


  </body>
{% endblock %}
